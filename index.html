<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>NexradJS</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
    <link href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css" rel="stylesheet">

    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>

    <!-- https://cdnjs.com/libraries/font-awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

    <!-- https://getbootstrap.com/docs/5.2/getting-started/download/ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>

    <!-- https://getbootstrap.com/docs/5.2/components/tooltips/ -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js"></script>

    <!-- https://github.com/manuelbieh/geolib -->
    <script src="https://cdn.jsdelivr.net/npm/geolib@3.3.3/lib/index.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .false-anchor {
            cursor: pointer;
            text-decoration: underline;
            color:rgb(0, 0, 238) !important;
        }
        .false-anchor:hover {
            color:rgb(0, 0, 131) !important;
        }
        
        .icon-black {
            color:rgb(0, 0, 0);
        }
        .icon-selected {
            color:rgb(0, 132, 255);
        }

        .mapboxgl-ctrl-top-center {
            position: relative !important;
            left: 0;
            right: 0;
            top: 10px;
            align-items: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .mapboxgl-ctrl-bottom-center {
            position: absolute !important;
            left: 0;
            right: 0;
            bottom: 15px;
            align-items: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #messageBox {
            width: auto;
            height: auto;
            max-height: 50vh;
            overflow: auto;
            border: 1px solid rgb(0, 0, 0);
            padding: 2px;
            /*text-align: justify;*/
            background: transparent;
        }

        #spinnerParent {
            z-index: 10;
            margin: 0;
            padding: 0;
            position: absolute;
            bottom: 0;
            height: 100%;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.2);
        }
        #spinnerDisplayText {
            color: rgb(0, 162, 255);
            /*background-color: rgb(87, 87, 87);*/
            text-align: center;
            margin: auto;
            margin-top: 10%;
            font-size: 30px;
            font-family: Arial, Helvetica, sans-serif;
        }
        /*
        https://tobiasahlin.com/spinkit/
        */
        .sk-chase {
            width: 40px;
            height: 40px;
            position: absolute;
            top:0;
            bottom: 0;
            left: 0;
            right: 0;
            margin: auto;
            animation: sk-chase 2.5s infinite linear both;
        }
        
        .sk-chase-dot {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0; 
            animation: sk-chase-dot 1.0s infinite ease-in-out both; 
        }
        .sk-chase-dot:before {
            content: '';
            display: block;
            width: 25%;
            height: 25%;
            background-color: #fff;
            border-radius: 100%;
            animation: sk-chase-dot-before 1.0s infinite ease-in-out both; 
        }
        .sk-chase-dot:nth-child(1) { animation-delay: -1.1s; }
        .sk-chase-dot:nth-child(2) { animation-delay: -1.0s; }
        .sk-chase-dot:nth-child(3) { animation-delay: -0.9s; }
        .sk-chase-dot:nth-child(4) { animation-delay: -0.8s; }
        .sk-chase-dot:nth-child(5) { animation-delay: -0.7s; }
        .sk-chase-dot:nth-child(6) { animation-delay: -0.6s; }
        .sk-chase-dot:nth-child(1):before { animation-delay: -1.1s; }
        .sk-chase-dot:nth-child(2):before { animation-delay: -1.0s; }
        .sk-chase-dot:nth-child(3):before { animation-delay: -0.9s; }
        .sk-chase-dot:nth-child(4):before { animation-delay: -0.8s; }
        .sk-chase-dot:nth-child(5):before { animation-delay: -0.7s; }
        .sk-chase-dot:nth-child(6):before { animation-delay: -0.6s; }
        
        @keyframes sk-chase {
            100% { transform: rotate(360deg); } 
        }
        @keyframes sk-chase-dot {
            80%, 100% { transform: rotate(360deg); } 
        }
        @keyframes sk-chase-dot-before {
            50% {
                transform: scale(0.6); 
            } 100%, 0% {
                transform: scale(1.0); 
            } 
        }

        #optionsBox {
            position: absolute;
            z-index: 100;
            position: absolute;
            left: 25%;
            right: 25%;
            bottom: 5%;
            text-align: center;
            width: auto;
            height: 200px;
            overflow: scroll;
            padding: 5px 10px;
            /* line-height: 25px; */
            background-color: white;
            border: 1px solid black;
            border-radius: 5px;
        }
        .customMarker {
            text-align: center;
            width: auto;
            height: auto;
            padding: 1px 5px;
            /* line-height: 25px; */
            background-color: rgb(136, 136, 136);
            border: 1px solid black;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="spinnerParent" style="display: none">
        <!-- <div id="spinnerDisplayText">The radar is currently loading. Patience here is key - this should be quick.</div> -->
        <div class="sk-chase">
            <div class="sk-chase-dot"></div>
            <div class="sk-chase-dot"></div>
            <div class="sk-chase-dot"></div>
            <div class="sk-chase-dot"></div>
            <div class="sk-chase-dot"></div>
            <div class="sk-chase-dot"></div>
        </div>
    </div>
    <div id="fileStation" style="display: none"></div>
    <div id="fileVersion" style="display: none"></div>
    <div id="level3json" style="display: none"></div>
    <div id="decodedRadarDataURL" style="display: none"></div>
    <div id="allStormTracksLayers" style="display: none"></div>
    <div id="curProd" style="display: none"></div>
    <div id="prevStat" style="display: none"></div>
    <div id="testEventElem" style="display: none"></div>
    <!-- <a id="fileThatWorks" class="false-anchor">KTLX20130520_200356_V06.gz</a>
    <br>
    <a id="fileThatDoesnt" class="false-anchor">KLWX20220623_014344_V06</a>
    <br> -->
    <!-- <input id="fileInput" type="file"/> -->
    <br>
    <button id="plotRef" style="display: none">Ref</button>
    <button id="plotVel" style="display: none">Vel</button>
    <div id="messageDisplay" style="display: none"></div>
    <br><br><br>
    <canvas id="theCanvas" style="display: none"></canvas>

    <div id="settingsDialog" style="display: none">
        <a id="elevStuff" style="display: none">
            <div><b>Elevation:</b></div>
            <select id="elevInput">
                <!-- <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="17">17</option> -->
            </select>
            <br><br>
        </a>
        <a id="extraStuff" style="display: none">
            <input type="checkbox" id="shouldLowFilter">
            <label for="shouldLowFilter">Low Filter</label>
            <br><br>
        </a>
        <a id="productStuff" style="display: none">
            <div><b>Product:</b></div>
            <select id="productInput">
                <!-- <option value="REF" selected>Reflectivity</option>
                <option value="VEL">Velocity</option>
                <option value="RHO">Correlation Coefficient</option> -->
            </select>
            <br><br>
        </a>
        <a id="tiltStuff" style="display: none">
            <div><b>Tilt:</b></div>
            <select id="tiltInput">
                <option value="tilt1" selected>Tilt 1</option>
                <option value="tilt2">Tilt 2</option>
                <option value="tilt3">Tilt 3</option>
                <option value="tilt4">Tilt 4</option>
            </select>
            <br><br>
        </a>
        <div><b>Station:</b></div>
        <input id="userStation" value="KLWX">
        <br>
        <select id="levelInput">
            <option value="l2" selected>Level 2</option>
            <option value="l3">Level 3</option>
        </select>

        <input style="display:none" autofocus>
    </div>

    <div id="messageDialog" style="display: none">
        <div id="messageBox"></div>
    </div>

    <div id='optionsBox'>
        <label for="stationInp">Station</label>
        <input type="text" class="form-control" id="stationInp" value="KMHX">
        <br>
        <div class="dropdown-center" id="tiltDropdown">
            <button class="btn btn-secondary btn-sm dropdown-toggle" id="tiltDropdownBtn" type="button" data-bs-toggle="dropdown" aria-expanded="false" value="tilt1">
                Tilt 1</button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" value="tilt1">Tilt 1</a></li>
                <li><a class="dropdown-item" href="#" value="tilt2">Tilt 2</a></li>
                <li><a class="dropdown-item" href="#" value="tilt3">Tilt 3</a></li>
                <li><a class="dropdown-item" href="#" value="tilt4">Tilt 4</a></li>
            </ul>
        </div>
        <br>
        <div class="btn-group-vertical productBtnGroup">
            <div>Level 3</div>
            <!-- <button type="button" value="mcy" class="btn btn-outline-primary btn-sm">Mesocyclone</button> -->
            <button type="button" value="ref" class="btn btn-outline-primary btn-sm"><b>HR</b> Base Reflectivity</button>
            <button type="button" value="vel"  class="btn btn-outline-primary btn-sm"><b>HR</b> Base Velocity</button> <!-- vel -->
            <button type="button" value="hyc"  class="btn btn-outline-primary btn-sm">Hydrometer Classification</button> <!-- hyc -->
            <button type="button" value="hhc"  class="btn btn-outline-primary btn-sm">Hybrid Hydrometer Classification</button> <!-- hhc -->
            <button type="button" value="srv"  class="btn btn-outline-primary btn-sm">Storm Relative Velocity</button> <!-- srv -->
            <button type="button" value="ref" class="btn btn-outline-primary btn-sm">Digital Base Reflectivity</button> <!-- ref -->
            <button type="button" value="vil"  class="btn btn-outline-primary btn-sm">Vertically Integrated Liquid</button> <!-- vil -->
        </div>
        <br>
        <div class="btn-group-vertical productBtnGroup">
            <br>
            <div>Level 2</div>
            <button type="button" value="l2-ref" class="btn btn-outline-primary btn-sm">Base Reflectivity</button>
            <button type="button" value="l2-vel" class="btn btn-outline-primary btn-sm">Base Velocity</button>
            <button type="button" value="l2-rho" class="btn btn-outline-primary btn-sm">Correlation Coefficient</button>
            <button type="button" value="l2-phi" class="btn btn-outline-primary btn-sm">Differential Phase Shift</button>
            <button type="button" value="l2-zdr" class="btn btn-outline-primary btn-sm">Differential Reflectivity</button>
            <button type="button" value="l2-sw " class="btn btn-outline-primary btn-sm">Spectrum Width</button>
        </div>
    </div>

    <div id="map"></div>

    <!-- <canvas id="texturecolorbar" class="texturecolorbar"></canvas>
    <script type="x-shader/x-vertex" id="vertexShader">
        //x: azimuth
        //y: range
        //z: value
        attribute vec2 aPosition;
        attribute float aColor;
        uniform mat4 u_matrix;
        varying float color;

        void main() {
            color = aColor;
            gl_Position = u_matrix * vec4(aPosition.x,aPosition.y,0.0,1.0);
        }
    </script>
    <script type="x-shader/x-fragment" id="fragmentShader">
        precision mediump float;
        varying float color;
        uniform sampler2D u_texture;
        void main() {
            //gl_FragColor = vec4(0.0,color/60.0,0.0,1.0);
            float calcolor = (color)/(70.0);
            gl_FragColor = texture2D(u_texture,vec2(min(max(calcolor,0.0),1.0),0.0));
            //gl_FragColor = vec4(1.0,0.0,0.0,1.0);
        }
    </script>
    <script>
        //$.getJSON('./data/radar/KAMA_sub.json', function(data) {
        //  console.log(data);
        //})
    </script>
    <script src="./polygonTest/demo-radar-script.js"></script> -->

    <script>
        var parser = document.createElement('a');
        parser.href = window.location.href;
        console.log(parser.hash);

        var allParserArgs = parser.hash.split('&');
        console.log(allParserArgs)

        var isDevelopmentMode = false;
        for (key in allParserArgs) {
            if (allParserArgs[key].includes('#station=')) {
                console.log('we got a station URL parameter!');
                $('#stationInp').val(allParserArgs[key].slice(9, 13));
            }
            if (allParserArgs[key].includes('#development')) {
                console.log('we got a development mode URL parameter!');
                isDevelopmentMode = true;
            }
        }

        function logToModal(textContent) {
            console.log(textContent);
            function openMessageModal() {
                $("#messageDialog").dialog({
                    modal: true,
                    // https://stackoverflow.com/a/30624445/18758797
                    open: function () {
                        $(this).parent().css({
                            position: 'absolute',
                            top: 10,
                            maxHeight: '70vh',
                            overflow: 'scroll'
                        });
                    },
                });
            }
            if (!($("#messageDialog").dialog('instance') == undefined)) {
                // message box is already initialized
                if (!$('#messageDialog').closest('.ui-dialog').is(':visible')) {
                    // message box is initialized but hidden - open it
                    openMessageModal();
                }
            } else if ($("#messageDialog").dialog('instance') == undefined) {
                // message box is not initialized, open it
                openMessageModal();
            }
            $('#messageBox').append(`<div>${textContent}</div>`);
            $("#messageBox").animate({ scrollTop: $("#messageBox")[0].scrollHeight}, 0);
        }
    </script>
    <script>

        function xmlToJson(xml) {
            if (typeof xml == "string") {
                parser = new DOMParser();
                xml = parser.parseFromString(xml, "text/xml");
            }
            // Create the return object
            var obj = {};
            // console.log(xml.nodeType, xml.nodeName );
            if (xml.nodeType == 1) { // element
                // do attributes
                if (xml.attributes.length > 0) {
                obj["@attributes"] = {};
                    for (var j = 0; j < xml.attributes.length; j++) {
                        var attribute = xml.attributes.item(j);
                        obj["@attributes"][attribute.nodeName] = attribute.nodeValue;
                    }
                }
            } 
            else if (xml.nodeType == 3 || 
                     xml.nodeType == 4) { // text and cdata section
                obj = xml.nodeValue
            }
            // do children
            if (xml.hasChildNodes()) {
                for(var i = 0; i < xml.childNodes.length; i++) {
                    var item = xml.childNodes.item(i);
                    var nodeName = item.nodeName;
                    if (typeof(obj[nodeName]) == "undefined") {
                        obj[nodeName] = xmlToJson(item);
                    } else {
                        if (typeof(obj[nodeName].length) == "undefined") {
                            var old = obj[nodeName];
                            obj[nodeName] = [];
                            obj[nodeName].push(old);
                        }
                        if (typeof(obj[nodeName]) === 'object') {
                            obj[nodeName].push(xmlToJson(item));
                        }
                    }
                }
            }
            return obj;
        }
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';

            var k = 1024;
            var dm = decimals < 0 ? 0 : decimals;
            var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

            var i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        mapboxgl.accessToken = 'pk.eyJ1Ijoic3RlZXBhdHRpY3N0YWlycyIsImEiOiJjbDNvaGFod2EwbXluM2pwZTJiMDYzYjh5In0.J_HeH00ry0tbLmGmTy4z5w';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v10',
            zoom: 3,
            center: [-98.5606744, 36.8281576],
            //projection: 'equirectangular',
        });
        var phpProxy = 'https://php-cors-proxy.herokuapp.com/?';
        map.on('load', function() {
            /*map.addLayer({
                'id': `wms-test-layer`,
                'type': 'raster',
                'source': {
                    'type': 'raster',
                    // use the tiles option to specify a WMS tile source URL
                    // https://docs.mapbox.com/mapbox-gl-js/style-spec/sources/
                    'tiles': [
                        `${phpProxy}https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/ridge::JAX-N0B-0/{z}/{x}/{y}.png`
                        //'https://img.nj.gov/imagerywms/Natural2015?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&width=256&height=256&layers=Natural2015'
                        //'https://opengeo.ncep.noaa.gov/geoserver/klwx/klwx_bref_raw/ows?&service=WMS&request=GetMap&layers=&styles=&format=image/png&transparent=true&version=1.1.1&SERVICE=WMS&LAYERS=klwx_bref_raw&width=256&height=256&srs=EPSG:3857&bbox={bbox-epsg-3857}'
                        //https://opengeo.ncep.noaa.gov/geoserver/klwx/klwx_bref_raw/ows?&service=WMS&request=GetMap&layers=&styles=&format=image/png&transparent=true&version=1.1.1&SERVICE=WMS&LAYERS=klwx_bref_raw&width=256&height=256&srs=EPSG:3857&bbox=-20037508.342789244,0,-10018754.171394622,10018754.17139462
                    ],
                    'tileSize': 256
                },
            });*/
        })

        function loadFileObject(path, name, level, product) {
            var radLevel;
            var wholeOrPart = 'whole';
            if (level == 2) {
                radLevel = 'level2';
            } if (level == 22) {
                radLevel = 'level2';
                wholeOrPart = 'part';
            } else if (level == 3) {
                radLevel = 'level3';
            }
            var xhr = new XMLHttpRequest();
            xhr.open("GET", path);
            xhr.responseType = "blob";
            xhr.addEventListener('load', function() {
                var blob = xhr.response;
                blob.lastModifiedDate = new Date();
                blob.name = name;
                // Create the event
                var event = new CustomEvent("loadFile", { "detail": [
                    blob,
                    radLevel,
                    wholeOrPart,
                    product
                ] });
                // Dispatch/Trigger/Fire the event
                document.dispatchEvent(event);
            });
            xhr.onprogress = (event) => {
                // event.loaded returns how many bytes are downloaded
                // event.total returns the total number of bytes
                // event.total is only available if server sends `Content-Length` header
                //console.log(`%c Downloaded ${formatBytes(event.loaded)} of ${formatBytes(event.total)}`, 'color: #bada55');
                //var complete = (event.loaded / event.total * 50 | 0);
                console.log(formatBytes(event.loaded))
            }
            xhr.send();
        }

        // https://github.com/mapbox/mapbox-gl-js/issues/3039#issuecomment-401964567
        function registerControlPosition(map, positionName) {
            if (map._controlPositions[positionName]) {
                return;
            }
            var positionContainer = document.createElement('div');
            positionContainer.className = `mapboxgl-ctrl-${positionName}`;
            map._controlContainer.appendChild(positionContainer);
            map._controlPositions[positionName] = positionContainer;
        }
        registerControlPosition(map, 'top-center');
        registerControlPosition(map, 'bottom-center');
        registerControlPosition(map, 'center');

        class infoControl {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.innerHTML = `
                    <div id='infoContainer' style='
                    display: none;
                    text-align: center;
                    width: auto;
                    height: auto;
                    padding: 5px 10px;
                    /* line-height: 25px; */
                    background-color: white;
                    border: 1px solid black;
                    border-radius: 5px;
                    '>
                        <input id="fileInput" type="file"/>
                        <div id='radarInfoDiv' style='display: none'>
                            <div id='radFileNameParent'><b><a id='radFileName'></a></b></div>
                            <div id='radDateParent'><b>Date: </b><a id='radDate'></a></div>
                            <b>Station: </b><a id='radStation'></a>
                            <b>VCP: </b><a id='radVCP'></a>
                        </div>
                    </div>`
                this._container.addEventListener('click', function() {
                    console.log('sus')
                })
                return this._container;
            }

            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }
        var theInfoControl = new infoControl
        map.addControl(theInfoControl, 'top-center');

        class infoControlBottom {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.innerHTML = `
                    <div id='infoContainerBottom' style='
                    text-align: center;
                    width: auto;
                    height: auto;
                    padding: 5px 10px;
                    /* line-height: 25px; */
                    background-color: white;
                    border: 1px solid black;
                    border-radius: 5px;
                    '>
                        <canvas id="texturecolorbar" class="texturecolorbar" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Default tooltip" data-bs-animation="false"></canvas>
                    </div>`
                return this._container;
            }

            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }
        var theInfoControlBottom = new infoControlBottom
        map.addControl(theInfoControlBottom, 'top-center');

        document.getElementById("texturecolorbar").width = 0;
        document.getElementById("texturecolorbar").height = 0;

        // enable bootstrap tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

        function showPlotBtn() {
            class reflPlotControl {
                onAdd(map) {
                    this._map = map;
                    this._container = document.createElement('div');
                    this._container.innerHTML = `
                        <div class="mapboxgl-control-container" style="margin-top: 100%;">
                            <div class="mapboxgl-ctrl mapboxgl-ctrl-group">
                                <button class="mapboxgl-ctrl-fullscreen" type="button" aria-label="Globe Toggle">
                                    <span class="fa fa-hurricane icon-black" id="reflPlotThing" aria-hidden="true" title="Globe Toggle"></span>
                                </button>
                            </div>
                        </div>`
                    $(this._container).addClass('reflPlotButton');
                    this._container.addEventListener('click', function() {
                        if (!$('#reflPlotThing').hasClass('icon-selected')) {
                            $('#reflPlotThing').addClass('icon-selected');
                            $('#reflPlotThing').removeClass('icon-black');
                        } else if ($('#reflPlotThing').hasClass('icon-selected')) {
                            $('#reflPlotThing').removeClass('icon-selected');
                            $('#reflPlotThing').addClass('icon-black');
                            removeMapLayer('baseReflectivity');
                        }
                    })
                    return this._container;
                }

                onRemove() {
                    this._container.parentNode.removeChild(this._container);
                    this._map = undefined;
                }
            }
            var theReflPlotControl = new reflPlotControl;
            map.addControl(theReflPlotControl, 'top-left');
        }
        //showPlotBtn();

        class settingsControl {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.innerHTML = `
                    <div class="mapboxgl-control-container" style="margin-top: 100%;">
                        <div class="mapboxgl-ctrl mapboxgl-ctrl-group">
                            <button class="mapboxgl-ctrl-fullscreen" type="button" aria-label="Globe Toggle">
                                <span class="fa fa-gear icon-black" id="settingsThing" aria-hidden="true" title="Globe Toggle"></span>
                            </button>
                        </div>
                    </div>`
                this._container.addEventListener('click', function() {
                    if (!$('#settingsThing').hasClass('icon-selected')) {
                        $('#settingsThing').addClass('icon-selected');
                        $('#settingsThing').removeClass('icon-black');
                        $("#settingsDialog").dialog({
                            modal: true,
                            // https://stackoverflow.com/a/30624445/18758797
                            open: function () {
                                $(this).parent().css({
                                    position: 'absolute',
                                    top: 10,
                                    maxHeight: '70vh',
                                    overflow: 'scroll'
                                });
                                $('.ui-widget-overlay').bind('click', function() {
                                    $("#settingsDialog").dialog('close'); 
                                }); 
                            },
                            close: function () {
                                $('#settingsThing').removeClass('icon-selected');
                                $('#settingsThing').addClass('icon-black');
                            }
                        });
                    } else if ($('#settingsThing').hasClass('icon-selected')) {
                        $('#settingsThing').removeClass('icon-selected');
                        $('#settingsThing').addClass('icon-black');
                    }
                })
                return this._container;
            }

            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }
        var theSettingsControl = new settingsControl;
        //map.addControl(theSettingsControl, 'top-right');

        class testFileControl {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.innerHTML = `
                    <div class="mapboxgl-control-container" style="margin-top: 100%;">
                        <div class="mapboxgl-ctrl mapboxgl-ctrl-group">
                            <button class="mapboxgl-ctrl-fullscreen" type="button" aria-label="Globe Toggle">
                                <span class="fa fa-flask-vial icon-black" id="testFileThing" aria-hidden="true" title="Globe Toggle"></span>
                            </button>
                        </div>
                    </div>`
                this._container.addEventListener('click', function() {
                    if (!$('#testFileThing').hasClass('icon-selected')) {
                        $('#testFileThing').addClass('icon-selected');
                        $('#testFileThing').removeClass('icon-black');
                        // KLIX20050829_061516.gz
                        // KTLX20130520_200356_V06.gz
                        var fileToLoad = 'KTLX20130520_200356_V06.gz';
                        loadFileObject('data/' + fileToLoad, fileToLoad, 2);
                    } else if ($('#testFileThing').hasClass('icon-selected')) {
                        $('#testFileThing').removeClass('icon-selected');
                        $('#testFileThing').addClass('icon-black');
                    }
                })
                return this._container;
            }

            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }
        var theTestFileControl = new testFileControl;

        class testFile3Control {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.innerHTML = `
                    <div class="mapboxgl-control-container" style="margin-top: 100%;">
                        <div class="mapboxgl-ctrl mapboxgl-ctrl-group">
                            <button class="mapboxgl-ctrl-fullscreen" type="button" aria-label="Globe Toggle">
                                <span class="fa fa-3 icon-black" id="testFile3Thing" aria-hidden="true" title="Globe Toggle"></span>
                            </button>
                        </div>
                    </div>`
                this._container.addEventListener('click', function() {
                    if (!$('#testFile3Thing').hasClass('icon-selected')) {
                        $('#testFile3Thing').addClass('icon-selected');
                        $('#testFile3Thing').removeClass('icon-black');
                        // LWX_N0H_2022_04_18_15_21_24
                        // LWX_N0Q_2022_04_18_15_21_24
                        // KOUN_SDUS54_N0STLX_201305200301
                        // KCRP_SDUS54_N0UCRP_201708252357
                        // KOUN_SDUS54_DVLTLX_201305200301
                        // KOUN_SDUS34_NSTTLX_201305200301

                        // LOT_NMD_2021_06_21_04_22_17
                        // LOT_NMD_2021_06_21_04_27_31
                        // ESX_NMD_2022_07_31_21_50_40
                        var fileToLoad = 'LOT_NMD_2021_06_21_04_22_17';
                        loadFileObject('data/level3/' + fileToLoad, fileToLoad, 3);
                    } else if ($('#testFile3Thing').hasClass('icon-selected')) {
                        $('#testFile3Thing').removeClass('icon-selected');
                        $('#testFile3Thing').addClass('icon-black');
                    }
                })
                return this._container;
            }

            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }
        var theTestFile3Control = new testFile3Control;

        if (isDevelopmentMode) {
            map.addControl(theTestFile3Control, 'top-right');
            map.addControl(theTestFileControl, 'top-right');
        }

        function getLatestFile(sta, callbck) {
            document.getElementById('spinnerParent').style.display = 'block';
            var curTime = new Date();
            var year = curTime.getUTCFullYear();
            var month = curTime.getUTCMonth() + 1;
            month = "0" + month.toString();
            var day = curTime.getUTCDate();
            day = "0" + day.toString();
            var stationToGet = sta.toUpperCase().replace(/ /g, '')
            var fullURL = "https://noaa-nexrad-level2.s3.amazonaws.com/?list-type=2&delimiter=%2F&prefix=" + year + "%2F" + month + "%2F" + day + "%2F" + stationToGet + "%2F"
            //console.log(fullURL)
            $.get(phpProxy + fullURL, function (data) {
                var dataToWorkWith = JSON.stringify(xmlToJson(data)).replace(/#/g, 'HASH')
                dataToWorkWith = JSON.parse(dataToWorkWith)
                //console.log(dataToWorkWith)
                var filenameKey = dataToWorkWith.ListBucketResult.Contents
                var latestFileName = filenameKey[filenameKey.length - 1].Key.HASHtext.slice(16);
                if (latestFileName.includes('MDM')) {
                    latestFileName = filenameKey[filenameKey.length - 2].Key.HASHtext.slice(16);
                }
                callbck(latestFileName, year, month, day, stationToGet);
            })
        }

        function getLatestL3File(sta, pro, cb) {
            document.getElementById('spinnerParent').style.display = 'block';
            var curTime = new Date();
            var year = curTime.getUTCFullYear();
            var month = curTime.getUTCMonth() + 1;
            month = "0" + month.toString();
            var day = curTime.getUTCDate();
            day = "0" + day.toString();
            var stationToGet = sta.toUpperCase().replace(/ /g, '')
            var urlBase = "https://unidata-nexrad-level3.s3.amazonaws.com/";
            var filenamePrefix = `${sta}_${pro}_${year}_${month}_${day}`;
            var urlPrefInfo = '?list-type=2&delimiter=/%2F&prefix=';
            var fullURL = `${urlBase}${urlPrefInfo}${filenamePrefix}`
            //console.log(fullURL)
            $.get(phpProxy + fullURL, function (data) {
                var dataToWorkWith = JSON.stringify(xmlToJson(data)).replace(/#/g, 'HASH')
                dataToWorkWith = JSON.parse(dataToWorkWith)
                var contentsBase = dataToWorkWith.ListBucketResult.Contents;
                var filenameKey = contentsBase[contentsBase.length - 1].Key.HASHtext;

                var finishedURL = `${urlBase}${filenameKey}`;
                cb(finishedURL);
            })
        }

        function loadLatestFile(levell, pr, tilt, stat) {
            var numLevel = 2;
            if (levell == 'l22') {
                numLevel = 22;
            }
            if (levell == 'l2' || levell == 'l22') {
                removeMapLayer('baseReflectivity');
                getLatestFile($('#stationInp').val(), function(fileName, y, m, d, s) {
                    var individualFileURL = `https://noaa-nexrad-level2.s3.amazonaws.com/${y}/${m}/${d}/${s}/${fileName}`
                    console.log(phpProxy + individualFileURL)
                    loadFileObject(phpProxy + individualFileURL, fileName, numLevel, pr);
                });
            } else if (levell == 'l3') {
                if ($('#productInput').val() != 'sti') {
                    removeMapLayer('baseReflectivity');
                }
                var tiltProduct = tiltObject[tilt][pr];
                if (pr != 'ref') {
                    // https://tgftp.nws.noaa.gov/SL.us008001/DF.of/DC.radar/DS.165h0/SI.kgld/sn.last
                    // DS.165h0 = product code 165, N0H (h0)
                    var level3url = `${phpProxy}https://tgftp.nws.noaa.gov/SL.us008001/DF.of/DC.radar/DS.${tiltProduct}/SI.${stat}/sn.last`
                    console.log(level3url)
                    console.log(tiltProduct, stat)
                    loadFileObject(level3url, 'sn.last', 3);
                } else {
                    getLatestL3File(stat.toUpperCase().slice(1), tiltProduct, function(cbVal) {
                        var proxiedCbVal = `${phpProxy}${cbVal}`;
                        console.log(cbVal);
                        loadFileObject(proxiedCbVal, 'sn.last', 3);
                    });
                }
            }
        }

        class curFileControl {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.innerHTML = `
                    <div class="mapboxgl-control-container" style="margin-top: 100%;">
                        <div class="mapboxgl-ctrl mapboxgl-ctrl-group">
                            <button class="mapboxgl-ctrl-fullscreen" type="button" aria-label="Globe Toggle">
                                <span class="fa fa-clock icon-black" id="curFileThing" aria-hidden="true" title="Globe Toggle"></span>
                            </button>
                        </div>
                    </div>`
                this._container.classList.add('currentFileControl');
                this._container.addEventListener('click', function() {
                    if (!$('#curFileThing').hasClass('icon-selected')) {
                        $('#curFileThing').addClass('icon-selected');
                        $('#curFileThing').removeClass('icon-black');
                        if ($('#levelInput').val() == 'l2') {
                            loadLatestFile('l2');
                        } else if ($('#levelInput').val() == 'l3') {
                            loadLatestFile('l3');
                        }
                    } else if ($('#curFileThing').hasClass('icon-selected')) {
                        $('#curFileThing').removeClass('icon-selected');
                        $('#curFileThing').addClass('icon-black');
                    }
                })
                return this._container;
            }

            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }
        var theCurFileControl = new curFileControl;
        //map.addControl(theCurFileControl, 'top-right');

        var tiltObject = {
            'tilt1': {
                'ref': 'N0B',
                'vel': 'p99v0',
                'hhc': '177hh',
                'hyc': '165h0',
                'srv': '56rm0',
                'vil': '134il',
                'sti': '58sti',
                'mcy': '141md',
            },
            'tilt2': {
                'ref': 'N1B',
                'vel': 'p99v1',
                'hhc': '177hh',
                'hyc': '165h1',
                'srv': '56rm1',
                'vil': '134il',
                'sti': '58sti',
            },
            'tilt3': {
                'ref': 'N2B',
                'vel': 'p99v2',
                'hhc': '177hh',
                'hyc': '165h2',
                'srv': '56rm2',
                'vil': '134il',
                'sti': '58sti',
            },
            'tilt4': {
                'ref': 'N3B',
                'vel': 'p99v3',
                'hhc': '177hh',
                'hyc': '165h3',
                'srv': '56rm3',
                'vil': '134il',
                'sti': '58sti',
            },
        }

        var allL2Btns = [
            'l2-ref',
            'l2-vel',
            'l2-rho',
            'l2-phi',
            'l2-zdr',
            'l2-sw '
        ];
        $('.productBtnGroup button').on('click', function() {
            //$('#productInput').val()
            var initInnerHTML = this.innerHTML;
            if (!initInnerHTML.includes('span')) {
                this.innerHTML = `<span class="spinner-border spinner-border-sm text-dark" role="status" aria-hidden="true"></span>&nbsp;&nbsp;` + initInnerHTML;
                var thisBtn = this;
                document.getElementById('testEventElem').addEventListener('DOMSubtreeModified', function() {
                    thisBtn.innerHTML = initInnerHTML;
                }, {once : true})
            }
            $('.btn-outline-success').each(function() {
                $(this).removeClass('btn-outline-success');
                $(this).addClass('btn-outline-primary');
            });
            $(this).removeClass('btn-outline-primary');
            $(this).addClass('btn-outline-success');
            document.getElementById('curProd').innerHTML = this.value;
            if (!allL2Btns.includes(this.value)) {
                loadLatestFile(
                    'l3',
                    this.value,
                    $('#tiltDropdownBtn').attr('value'),
                    $('#stationInp').val().toLowerCase()
                );
            } else {
                loadLatestFile('l2', this.value);
            }
        });
        $('#tiltDropdown a').on('click', function() {
            document.getElementById('tiltDropdownBtn').innerHTML = this.innerHTML;
            $('#tiltDropdownBtn').attr('value', $(this).attr('value'))

            if (document.getElementById('curProd').innerHTML != '') {
                loadLatestFile(
                    'l3',
                    document.getElementById('curProd').innerHTML,
                    $(this).attr('value'),
                    $('#stationInp').val().toLowerCase()
                );
            }
        })

        var statMarkerArr = [];
        function showStations() {
            $.getJSON('https://steepatticstairs.github.io/weather/json/radarStations.json', function(data) {
                var allKeys = Object.keys(data);
                for (key in allKeys) {
                    var curIter = data[allKeys[key]];
                    var curStat = allKeys[key];

                    // check if it is an unsupported radar
                    if (curStat.charAt(0) == 'K') {
                        // create a HTML element for each feature
                        var el = document.createElement('div');
                        el.className = 'customMarker';
                        el.innerHTML = curStat;

                        // make a marker for each feature and add to the map
                        var mark = new mapboxgl.Marker(el)
                            .setLngLat([curIter[2], curIter[1]])
                            .addTo(map);
                        statMarkerArr.push(mark)
                    }
                }
            }).then(function() {
                $('.customMarker').on('click', function() {
                    $('#stationInp').val(this.innerHTML)
                })
            })
        }

        class stationControl {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.innerHTML = `
                    <div class="mapboxgl-control-container" style="margin-top: 100%;">
                        <div class="mapboxgl-ctrl mapboxgl-ctrl-group">
                            <button class="mapboxgl-ctrl-fullscreen" type="button" aria-label="Globe Toggle">
                                <span class="fa fa-satellite-dish icon-black" id="stationThing" aria-hidden="true"></span>
                            </button>
                        </div>
                    </div>`
                this._container.addEventListener('click', function() {
                    if (!$('#stationThing').hasClass('icon-selected')) {
                        $('#stationThing').addClass('icon-selected');
                        $('#stationThing').removeClass('icon-black');
                        showStations();
                    } else if ($('#stationThing').hasClass('icon-selected')) {
                        $('#stationThing').removeClass('icon-selected');
                        $('#stationThing').addClass('icon-black');
                        for (key in statMarkerArr) {
                            statMarkerArr[key].remove();
                        }
                    }
                })
                return this._container;
            }

            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }
        var theStationControl = new stationControl;
        map.addControl(theStationControl, 'top-left');

        class showOptionsBoxControl {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.innerHTML = `
                    <div class="mapboxgl-control-container" style='position: absolute; bottom: 10vh'>
                        <div class="mapboxgl-ctrl mapboxgl-ctrl-group">
                            <button class="mapboxgl-ctrl-fullscreen" type="button" aria-label="Globe Toggle">
                                <span class="fa fa-circle-chevron-up icon-black" id="showOptionsBoxThing" aria-hidden="true"></span>
                            </button>
                        </div>
                    </div>`
                this._container.classList.add('optionsBoxControl');
                this._container.addEventListener('click', function() {
                    if (!$('#showOptionsBoxThing').hasClass('icon-selected')) {
                        $('#showOptionsBoxThing').addClass('icon-selected');

                        $('#showOptionsBoxThing').removeClass('fa-circle-chevron-up');
                        $('#showOptionsBoxThing').addClass('fa-circle-chevron-down');

                        $('#showOptionsBoxThing').removeClass('icon-black');
                        $('#optionsBox').show("slide", { direction: "down" }, 200);
                    } else if ($('#showOptionsBoxThing').hasClass('icon-selected')) {
                        $('#showOptionsBoxThing').removeClass('icon-selected');

                        $('#showOptionsBoxThing').removeClass('fa-circle-chevron-down');
                        $('#showOptionsBoxThing').addClass('fa-circle-chevron-up');

                        $('#showOptionsBoxThing').addClass('icon-black');
                        $('#optionsBox').hide("slide", { direction: "down" }, 200);
                    }
                })
                return this._container;
            }

            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }
        var theShowOptionsBoxControl = new showOptionsBoxControl;
        map.addControl(theShowOptionsBoxControl, 'bottom-left');

        //$('#optionsBox').hide();
        $('.optionsBoxControl').trigger('click');

        $('#levelInput').on('change', function() {
            if ($('#levelInput').val() == 'l2') {
                document.getElementById('productStuff').style.display = 'none';
                document.getElementById('tiltStuff').style.display = 'none';
                $('#productInput').empty();
            } else if ($('#levelInput').val() == 'l3') {
                $('#productStuff').on('change', function() {
                    if ($('#levelInput').val() == 'l3' && map.getLayer('baseReflectivity')) {
                        loadLatestFile('l3');
                    }
                })
                $('#tiltInput').on('change', function() {
                    if ($('#levelInput').val() == 'l3' && map.getLayer('baseReflectivity')) {
                        loadLatestFile('l3');
                    }
                })
                document.getElementById('productStuff').style.display = 'block';
                document.getElementById('tiltStuff').style.display = 'block';

                document.getElementById('productInput').add(new Option('Base Reflectivity', 'ref', false, true));
                document.getElementById('productInput').add(new Option('Base Velocity', 'vel'));
                document.getElementById('productInput').add(new Option('Hydrometer Classification', 'hyc'));
                document.getElementById('productInput').add(new Option('Vertically Integrated Liquid', 'vil'));
                document.getElementById('productInput').add(new Option('Hybrid Hydrometer Classification', 'hhc'));
                document.getElementById('productInput').add(new Option('Storm Relative Velocity', 'srv'));
                //document.getElementById('productInput').add(new Option('Storm Tracking', 'sti'));
            }
        })
        $('#levelInput').val('l3');
        $('#levelInput').trigger('change');

        // radius of wsr-88d scan in km
        var radius = 460;
        $('#fileStation').on('DOMSubtreeModified', function() {
            var station = document.getElementById('fileStation').innerHTML;
            $.getJSON('https://steepatticstairs.github.io/weather/json/radarStations.json', function(data) {
                var stationLat = data[station][1];
                var stationLng = data[station][2];
                //map.flyTo({
                //    center: [stationLng, stationLat],
                //    zoom: 8,
                //    duration: 1000,
                //});
                var stationBbox = getBoundingBox(stationLat, stationLng, radius);

                var coord1 = stationBbox.minLat;
                var coord2 = stationBbox.minLng;
                var coord3 = stationBbox.maxLat;
                var coord4 = stationBbox.maxLng;
                //map.addLayer({
                //    id: 'canvas-layer',
                //    type: 'raster',
                //    source: {
                //        type: 'canvas',
                //        canvas: 'theCanvas',
                //        coordinates: [
                //            [coord2, coord3],
                //            [coord4, coord3],
                //            [coord4, coord1],
                //            [coord2, coord1]
                //        ],
                //    }
                //});
                //new mapboxgl.Marker()
                //    .setLngLat([stationLng, stationLat])
                //    .addTo(map);
            });
        });
        function testHello(text) {
            console.log(text)
        }
        function removeMapLayer(layername) {
            if (map.getLayer(layername)) {
                map.removeLayer(layername);
            }
            if (map.getSource(layername)) {
                map.removeSource(layername);
            }
        }
        function removeTestFileControl() {
            if (map.hasControl(theTestFileControl)) {
                map.removeControl(theTestFileControl);
            }
            if (map.hasControl(theTestFile3Control)) {
                map.removeControl(theTestFile3Control);
            }
            if (map.hasControl(theCurFileControl)) {
                map.removeControl(theCurFileControl);
            }
        }

        function setGeojsonLayer(gj, gjType, identity) {
            var styling;
            var type;
            if (gjType == 'circle') {
                type = gjType;
                styling = {
                    'circle-radius': 4,
                    'circle-stroke-width': 2,
                    'circle-color': 'red',
                    'circle-stroke-color': 'white',
                }
            } else if (gjType == 'lineCircle') {
                type = 'circle';
                styling = {
                    'circle-radius': 4,
                    'circle-stroke-width': 2,
                    'circle-color': 'blue',
                    'circle-stroke-color': 'white',
                }
            } else if (gjType == 'lineCircleEdge') {
                type = 'circle';
                styling = {
                    'circle-radius': 4,
                    'circle-color': '#ffffff',
                }
            } else if (gjType == 'line') {
                type = gjType;
                styling = {
                    'line-color': '#ffffff',
                    'line-width': 1.5,
                }
            }
            map.addLayer({
                'id': identity,
                'type': type,
                'source': {
                    'type': 'geojson',
                    'data': gj,
                },
                'paint': styling,
            })
        }
        function moveMapLayer(lay) {
            if (map.getLayer(lay)) {
                map.moveLayer(lay)
            }
        }
    </script>
    <script src="utils.js"></script>
    <script src="./dist/bundle.js"></script>
    <script src="./polygonTest/demo-radar-script.js"></script>
</body>
</html>